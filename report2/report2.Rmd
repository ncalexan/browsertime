---
title: "browsertime: Chrome 73 vs GVE 68 ARM vs Fenix 68 ARM vs Fennec 64 on the Moto G5"
author: Nick Alexander
date: April 08, 2019
output:
  html_document:
    toc: true
    toc_float: true
    theme: cosmo
    includes:
      in_header: "html/header.html"
---

<style>
select {
    width: 30%;
    right: 10px;
    height: 30px;
}
</style>

```{r setup, include=FALSE}
library(glue)
library(dplyr)
library(DT)
library(ggplot2)
library(stringr)
library(tidyr)

btr <- read.csv('data/data.csv')
by_site <- btr %>%
  filter(proxy == 'replay') %>%
  select(-proxy, -timestamp) %>%
  mutate(run=1)

# The corpus was run in different vehicles and (sadly) across an Android update.  Use that data to map from engine to vehicle. 
by_site <- by_site %>% mutate(vehicle = case_when(
  grepl("Chrome/73.0", engine, fixed=TRUE) ~ "Chrome 73",
  grepl("Gecko/64.0", engine, fixed=TRUE) ~ "Fennec 64",
  grepl("Gecko/68.0", engine, fixed=TRUE) & grepl("Android 8.1.0", engine, fixed=TRUE) ~ "Fenix 68 ARM",
  grepl("Gecko/68.0", engine, fixed=TRUE) & grepl("Android 7.0", engine, fixed=TRUE) ~ "GVE 68 ARM"
))

# Ordering the vehicle factor in this way makes the dot-plot below generally "follow reality": Fennec is slowest, then Fenix, then GVE, then Chrome.
by_site$vehicle <- factor(by_site$vehicle, levels=c("Fennec 64", "Fenix 68 ARM", "GVE 68 ARM", "Chrome 73"))

by_site <- select(by_site, -engine)

runs <- data.frame(run = c(1, 2, 3, 4),
                   device = factor(c("Moto G5", "Moto G5", "Moto G5", "Moto G5")),
                   iterations = c(9, 9, 9, 9),
                   min_iterations = c(8, 8, 8, 8))

with_min_iterations <- by_site %>%
  group_by(run, device, site, vehicle) %>%
  summarise(num_iterations=n()) %>%
  ungroup() %>%
  group_by(run, device, site) %>%
  # This ensures that every "engine" has 0 if there were no runs recorded for that vehicle configuration.
  spread(vehicle, num_iterations, fill = 0) %>%
  gather("vehicle", num_iterations, levels(by_site$vehicle)) %>%
  ungroup() %>%
  group_by(run, device, site) %>%
  summarise(min_iterations=min(num_iterations)) %>%
  ungroup()

# Each (run, device, site) that has sufficient data to draw conclusions.
sufficient <- left_join(with_min_iterations, runs %>% select(-iterations), by = c("run", "device")) %>%
  filter(min_iterations.x >= min_iterations.y) %>%
  select(run, device, site)

# The measurements corresponding to (run, device, site) tuples with sufficient data.
complete <- semi_join(by_site, sufficient, by = c("run", "device", "site"))

complete_sites <- complete %>% select(site) %>% distinct()
```

## Per-device, per-site vehicle comparisons

The following graph gives insight into how the vehicles compare on the sites in
the test corpus.  Generally we see Chrome 73 fastest, followed by GVE 68 ARM,
followed closely by Fenix 68 AMR.  Fenix 64 is significantly slower than all
other vehicles.  The Stack Overflow URL shows this most clearly.

The gap between GVE and Fenix should be "pure overhead": things that Fenix does
to support tracking protection, providing UI updates, scheduling tasks, etc,
that The slimmer GeckoViewExample vehicle does not do.

```{r, echo=FALSE, fig.width = 12, fig.height=12}
# , fig.height=10
xx <- complete %>% group_by(device, run, site) %>% summarize(m=mean(pageLoadTime)) %>% ungroup() %>% arrange(m) %>% inner_join(complete, by=c('device', 'run', 'site'))
xx$site <- sub('https://', '', xx$site)
xx$site <- sub('http://', '', xx$site)
xx$site <- xx$site %>% str_trunc(30) %>% str_pad(30, 'right')

p <- ggplot(xx, aes(x=reorder(site, m), y=pageLoadTime))
p <- p + geom_point(aes(color=vehicle))
p <- p + facet_wrap(vars(device, run), ncol=1, scales='free', labeller=labeller(.multi_line=FALSE)) + theme(axis.text.x=element_text(angle=-67.5, hjust=0, vjust=0)) + xlab('site')
p <- p + theme(legend.justification = c(0, 1), legend.position = c(0.04, 0.995))
p
```

## Gecko engine vehicles over Chrome 73

```{r g_over_c, include=FALSE}
g_over_c <- complete %>%
  group_by(run, device, site, vehicle) %>%
  summarise(pageLoadTime_mean=mean(pageLoadTime)) %>% # , pageLoadTime_rsd=sd(pageLoadTime)/mean(pageLoadTime)*100) %>%
  ungroup() %>%
  group_by(run, device, site) %>%
  spread(vehicle, pageLoadTime_mean) %>%
  ungroup()

g_over_c[c("Fennec 64", "Fenix 68 ARM", "GVE 68 ARM")] <- g_over_c[c("Fennec 64", "Fenix 68 ARM", "GVE 68 ARM")] / g_over_c$`Chrome 73`

g_over_c <- g_over_c %>% select(-`Chrome 73`, -run)
```

```{r echo=FALSE}
datatable(g_over_c, options=list(dom='t', pageLength = nrow(g_over_c)),
          fillContainer = FALSE,
          caption=('Gecko engine vehicles pageload over Chrome pageload (lower is better)' %>% glue())) %>%
  # formatRound(c(3, 4), 2) %>%
  formatPercentage(c("Fennec 64", "Fenix 68 ARM", "GVE 68 ARM"))
```
